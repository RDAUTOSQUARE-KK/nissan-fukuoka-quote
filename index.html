<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>【日産福岡販売様】簡易見積ツール</title>
<style>
:root{--pad:14px;--gap:12px;--radius:14px;--fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#ffffff}
html,body{background:#fafafa;color:var(--fg)}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:640px;margin:0 auto;padding:env(safe-area-inset-top) var(--pad) env(safe-area-inset-bottom)}
.header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:16px 0 8px}
.badge{padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-size:12px;white-space:nowrap}
.card{border:1px solid var(--bd);border-radius:var(--radius);padding:var(--pad);margin:12px 0;background:var(--bg);box-shadow:0 1px 0 rgba(0,0,0,.02)}
.stack{display:flex;flex-direction:column;gap:var(--gap)}
label{font-weight:600;font-size:14px;display:block;margin-bottom:6px}
input,select,button{padding:12px;border:1px solid #d1d5db;border-radius:10px;width:100%;font-size:16px;background:#fff}
select{appearance:none;background-image:
 linear-gradient(45deg, transparent 50%, #9ca3af 50%),
 linear-gradient(135deg, #9ca3af 50%, transparent 50%),
 linear-gradient(to right, #d1d5db, #d1d5db);
background-position:calc(100% - 18px) calc(1em - 2px), calc(100% - 13px) calc(1em - 2px), calc(100% - 2.5rem) 50%;
background-size:5px 5px,5px 5px,1px 1.8em;background-repeat:no-repeat}
button{cursor:pointer;background:#111827;color:#fff;border:1px solid #111827;font-weight:700}
button:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#fff;color:#111827;border:1px solid #d1d5db}
.small{font-size:12px;color:var(--muted)}
.err{color:#b00020;margin-top:6px}
.kv{font-size:13px;color:#374151}
.kv b{display:inline-block;min-width:3.5rem}
.line{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #e5e7eb}
.line:last-child{border-bottom:none}
.total{font-size:20px;font-weight:800;margin-top:8px}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media (max-width:480px){.row-2{grid-template-columns:1fr}}
.note{font-size:12px;color:#374151;margin-top:8px}
.iteminfo{font-size:12px;color:#374151;margin-top:6px;white-space:pre-wrap}
</style>
</head>
<body>
  <div class="header">
    <span class="badge">ディーラー：日産福岡</span>
    <span class="badge" id="branchBadge">店舗：読込中...</span>
  </div>
  <div class="kv" id="branchContact" style="margin:4px 0 12px 0;"></div>

  <div class="card">
    <div class="stack">
      <div>
        <label>ご担当者様</label>
        <input id="salesperson" placeholder="入力してください">
      </div>

      <div>
        <label>車種コード（model_code）</label>
        <select id="vehicleSelect"></select>
        <div class="small" id="vehicleHelp">選択/入力すると自動で適合情報を読み込みます。</div>
        <div class="stack" style="margin-top:6px">
          <button class="btn-ghost" id="manualToggleBtn" aria-pressed="false">リストにない場合は手入力に切替</button>
          <input id="vehicleManual" placeholder="例: E13 / C28 / FE0" style="display:none">
        </div>
      </div>

      <!-- メインカテゴリ -->
      <div class="row-2">
        <div>
          <label>ナビゲーション</label>
          <select id="navTier"><option value="">選択なし</option></select>
          <div id="navInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>ETC</label>
          <select id="etcTier"><option value="">選択なし</option></select>
          <div id="etcInfo" class="iteminfo"></div>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label>ドライブレコーダー</label>
          <select id="drcTier"><option value="">選択なし</option></select>
          <div id="drcInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>バックカメラ</label>
          <select id="bcmTier"><option value="">選択なし</option></select>
          <div id="bcmInfo" class="iteminfo"></div>
        </div>
      </div>

      <div>
        <label>後席モニター</label>
        <select id="rseTier"><option value="">選択なし</option></select>
        <div id="rseInfo" class="iteminfo"></div>
      </div>

      <!-- オプション（プルダウン） -->
      <div class="row-2">
        <div>
          <label>携帯充電用USBコード</label>
          <select id="optUSB"><option value="">選択なし</option></select>
          <div id="optUSBInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>HDMI入力コード</label>
          <select id="optHDMI"><option value="">選択なし</option></select>
          <div id="optHDMIInfo" class="iteminfo"></div>
        </div>
      </div>
      <div>
        <label>ottocast</label>
        <select id="optOTTO"><option value="">選択なし</option></select>
        <div id="optOTTOInfo" class="iteminfo"></div>
      </div>

      <div class="stack">
        <button id="btnQuote">見積を表示</button>
        <div id="msg" class="err"></div>
        <div class="small">※ 店舗はQRのbranchパラメータから自動取得します。</div>
      </div>
    </div>
  </div>

  <!-- 結果 -->
  <div class="card" id="result" style="display:none">
    <div id="lines"></div>
    <div class="total" id="grand"></div>
    <div id="notes" class="note"></div>
  </div>

<script>
/* ===== 設定 ===== */
const FLOW_URL = "https://default65d7f344287e476a8e27e2ad17aaf5.f3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cc92c47cc1374afcb742cad801a2de4d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=qFlUmKJ42rtDOVD9jRbRy1NkE3AQTQmQMgX15viXKuA";
const API_KEY  = "aP5y72Kn";
const DEALER_CODE = "NISSAN_FUKUOKA";
const params = new URLSearchParams(location.search);
const BRANCH_CODE = (params.get('branch')||'').trim();

/* ===== 汎用 ===== */
const qs = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
let debounceTimer=null;
function debounce(fn, ms=400){ return (...a)=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>fn(...a), ms); }; }

/* 全リクエストに dealer / branch を自動付与 */
async function callFlow(body){
  const base = { dealer: DEALER_CODE, branch: BRANCH_CODE || '' };
  const res = await fetch(FLOW_URL, {
    method:"POST",
