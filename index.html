<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>【日産福岡販売様】簡易見積ツール</title>
<style>
:root{--pad:14px;--gap:12px;--radius:14px;--fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#ffffff}
html,body{background:#fafafa;color:var(--fg)}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:640px;margin:0 auto;padding:env(safe-area-inset-top) var(--pad) env(safe-area-inset-bottom)}
.header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:16px 0 8px}
.badge{padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-size:12px;white-space:nowrap}
.card{border:1px solid var(--bd);border-radius:var(--radius);padding:var(--pad);margin:12px 0;background:var(--bg);box-shadow:0 1px 0 rgba(0,0,0,.02)}
.stack{display:flex;flex-direction:column;gap:var(--gap)}
label{font-weight:600;font-size:14px;display:block;margin-bottom:6px}
input,select,button{padding:12px;border:1px solid #d1d5db;border-radius:10px;width:100%;font-size:16px;background:#fff}
select{appearance:none;background-image:
 linear-gradient(45deg, transparent 50%, #9ca3af 50%),
 linear-gradient(135deg, #9ca3af 50%, transparent 50%),
 linear-gradient(to right, #d1d5db, #d1d5db);
background-position:calc(100% - 18px) calc(1em - 2px), calc(100% - 13px) calc(1em - 2px), calc(100% - 2.5rem) 50%;
background-size:5px 5px,5px 5px,1px 1.8em;background-repeat:no-repeat}
button{cursor:pointer;background:#111827;color:#fff;border:1px solid #111827;font-weight:700}
button:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#fff;color:#111827;border:1px solid #d1d5db}
.small{font-size:12px;color:var(--muted)}
.err{color:#b00020;margin-top:6px}
.kv{font-size:13px;color:#374151}
.kv b{display:inline-block;min-width:3.5rem}
.line{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #e5e7eb}
.line:last-child{border-bottom:none}
.total{font-size:20px;font-weight:800;margin-top:8px}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media (max-width:480px){.row-2{grid-template-columns:1fr}}
.note{font-size:12px;color:#374151;margin-top:8px}
.iteminfo{font-size:12px;color:#374151;margin-top:6px;white-space:pre-wrap}

/* --- breakdown table --- */
.tbl { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px }
.tbl th, .tbl td { border:1px solid #e5e7eb; padding:6px 8px; vertical-align:top }
.tbl th { background:#f9fafb; text-align:left; white-space:nowrap }
.toggle { margin-top:10px }

/* ==== Loading overlay ==== */
.loading {
  position: fixed; inset: 0; display: none; place-items: center;
  background: rgba(255,255,255,.75); backdrop-filter: blur(1px); z-index: 9999;
}
.loading.show { display: grid; }
.spinner {
  width: 48px; height: 48px; border-radius: 50%;
  border: 4px solid #e5e7eb; border-top-color: #111827;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-msg { margin-top: 10px; color:#374151; font-size:14px; text-align:center }

/* ==== Export actions ==== */
.export-actions{margin:12px 0; display:flex; gap:8px}
.btn{padding:8px 12px; border:1px solid #ddd; background:#fff; cursor:pointer; color:#111827}
.btn:hover{background:#f5f5f5}

/* ==== Print optimization ==== */
@media print{
  .export-actions, .global-header, .footer, .spinner, .toggle, #btnQuote, #manualToggleBtn, .header { display:none !important; }
  #quoteRoot, #result { width:100% !important; margin:0 !important; }
  table { page-break-inside:auto; }
  tr, td, th { page-break-inside:avoid; page-break-after:auto; }
}
</style>
</head>
<body>
  <div class="header">
    <span class="badge">ディーラー：日産福岡</span>
    <span class="badge" id="branchBadge">店舗：読込中...</span>
  </div>
  <div class="kv" id="branchContact" style="margin:4px 0 12px 0;"></div>

  <div class="card">
    <div class="stack">
      <div>
        <label>ご担当者様</label>
        <input id="salesperson" placeholder="入力してください">
      </div>

      <div>
        <label>車種コード（model_code）</label>
        <select id="vehicleSelect"></select>
        <div class="small" id="vehicleHelp">選択/入力すると自動で適合情報を読み込みます。</div>
        <div class="stack" style="margin-top:6px">
          <button class="btn-ghost" id="manualToggleBtn" aria-pressed="false">リストにない場合は手入力に切替</button>
          <input id="vehicleManual" placeholder="例: E13 / C28 / FE0" style="display:none">
        </div>
      </div>

      <div class="row-2">
        <div>
          <label>ナビゲーション</label>
          <select id="navTier"><option value="">選択なし</option></select>
          <div id="navInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>ETC</label>
          <select id="etcTier"><option value="">選択なし</option></select>
          <div id="etcInfo" class="iteminfo"></div>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label>ドライブレコーダー</label>
          <select id="drcTier"><option value="">選択なし</option></select>
          <div id="drcInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>バックカメラ</label>
          <select id="bcmTier"><option value="">選択なし</option></select>
          <div id="bcmInfo" class="iteminfo"></div>
        </div>
      </div>

      <div>
        <label>後席モニター</label>
        <select id="rseTier"><option value="">選択なし</option></select>
        <div id="rseInfo" class="iteminfo"></div>
      </div>

      <div class="row-2">
        <div>
          <label>延長保証</label>
          <select id="optUSB"><option value="">選択なし</option></select>
          <div id="optUSBInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>HDMI入力コード</label>
          <select id="optHDMI"><option value="">選択なし</option></select>
          <div id="optHDMIInfo" class="iteminfo"></div>
        </div>
      </div>
      <div>
        <label>ottocast</label>
        <select id="optOTTO"><option value="">選択なし</option></select>
        <div id="optOTTOInfo" class="iteminfo"></div>
      </div>

      <div class="stack">
        <button id="btnQuote">見積を表示</button>
        <div id="msg" class="err"></div>
        <div class="small">※ 店舗情報は自動取得します。</div>
      </div>
    </div>
  </div>

  <div class="card" id="result" style="display:none">
    <div class="export-actions">
      <button id="btnCsv" class="btn">CSV出力</button>
      <button id="btnPdf" class="btn">PDF/印刷</button>
    </div>
    <div id="lines"></div>
    <div class="total" id="grand"></div>
    <button id="toggleDetail" class="btn-ghost toggle" style="display:none">詳細を表示</button>
    <div id="breakdown" style="display:none"></div>
    <div id="notes" class="note"></div>
  </div>

  <div id="loading" class="loading" aria-live="polite" aria-busy="true">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div class="spinner" role="progressbar" aria-label="読込中"></div>
      <div class="loading-msg" id="loadingMsg">読込中です…</div>
    </div>
  </div>

<script>
/* ===== 設定 ===== */
/* あなたが使っていた URL を維持します */
const FLOW_URL = "https://default65d7f344287e476a8e27e2ad17aaf5.f3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cc92c47cc1374afcb742cad801a2de4d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=qFlUmKJ42rtDOVD9jRbRy1NkE3AQTQmQMgX15viXKuA";
const DEALER_CODE = "NISSAN_FUKUOKA";
const params = new URLSearchParams(location.search);
const BRANCH_CODE = (params.get('branch')||'').trim();

/* ===== 汎用 ===== */
const qs = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
let debounceTimer=null;
function debounce(fn, ms=400){ return (...a)=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>fn(...a), ms); }; }

/* Loading overlay helpers */
function showLoading(msg){ const l=qs('loading'); const m=qs('loadingMsg'); if(msg) m.textContent=msg; l.classList.add('show'); }
function hideLoading(){ qs('loading').classList.remove('show'); }

/* 全リクエストに dealer / branch を付与 */
async function callFlow(body){
  const base = { dealer: DEALER_CODE, branch: BRANCH_CODE || '' };
  const res = await fetch(FLOW_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json", "Accept":"application/json" },
    body: JSON.stringify({ ...base, ...body })
  });
  if(!res.ok){
    const t = await res.text().catch(()=>String(res.status));
    throw new Error(`Flow HTTP ${res.status}: ${t}`);
  }
  return res.json();
}

/* ===== setSelect：見た目そのまま／カテゴリ別ラベル／BCMはPREMIUM非表示 ===== */
function setSelect(el, tiers, disabled, reason){
  if(!el) return;
  const id = el.id || "";
  const defaultLabels = { SIMPLE:"シンプル", BASIC:"ベーシック", PREMIUM:"プレミアム" };
  const labelMaps = {
    navTier: { SIMPLE:"ディスプレイオーディオ7インチ", BASIC:"ベーシック7インチ", PREMIUM:"プレミアム9インチ" },
    etcTier: { SIMPLE:"ETC1.0", BASIC:"ETC2.0", PREMIUM:"ETC2.0ナビ連動" },
    drcTier: { SIMPLE:"フロントのみ1カメラ", BASIC:"前後2カメラ", PREMIUM:"ナビ連動前後2カメラ" },
    bcmTier: { SIMPLE:"【アラウンドビューモニター用】ナビに映像出力", BASIC:"スタンダードバックカメラ", PREMIUM:null },
    rseTier: { SIMPLE:"10.1型フリップダウンモニター", BASIC:"9型ヘッドレスト裏モニター2セット（助手席・運転席）", PREMIUM:"13.3型フリップダウンモニター" }
  };
  const labels = labelMaps[id] || defaultLabels;

  el.innerHTML = `<option value="">${disabled?`選択不可（${reason||''}）`:'選択なし'}</option>`;
  let list = Array.isArray(tiers) ? tiers.slice() : String(tiers||'').split(',').filter(Boolean);

   if(!disabled){
    list.forEach(t=>{
      const key = String(t).toUpperCase().trim();
      const label = (labels[key] ?? defaultLabels[key] ?? key);
      if(label){ el.insertAdjacentHTML('beforeend', `<option value="${key}">${label}</option>`); }
    });
  }
  el.disabled = !!disabled;
}

/* ===== リセット（車種変更時） ===== */
function resetProductSelections(){
['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=>{
  const el = qs(id);
  if(!el) return;
  el.value = '';
  el.innerHTML = '<option value="">選択なし</option>';
  el.disabled = true;  // メインカテゴリは従来通り disable
});

// ★ OPT は disable にしない（中身だけクリア）
['optUSB','optHDMI','optOTTO'].forEach(id=>{
  const el = qs(id);
  if(!el) return;
  el.value = '';
  el.innerHTML = '<option value="">選択なし</option>';
  // el.disabled は触らない
});

  ['navInfo','etcInfo','drcInfo','bcmInfo','rseInfo','optUSBInfo','optHDMIInfo','optOTTOInfo'].forEach(id=>{
    const info = qs(id);
    if(info) info.textContent = '';
  });
  if (typeof selectedCatalogInfo === 'object' && selectedCatalogInfo){
    Object.keys(selectedCatalogInfo).forEach(k => selectedCatalogInfo[k] = null);
  }
}

/* ===== 起動時：店舗情報表示 ===== */
(async ()=>{
  const badge = qs('branchBadge'); const contact = qs('branchContact');
  if(!BRANCH_CODE){ badge.textContent = "店舗：未指定（コード無）"; return; }
  try{
    showLoading("店舗情報を取得中…");
    const info = await callFlow({ intent:"branchInfo", vehicle:"" });
    const b = info.branch || {};
    badge.textContent = "店舗：" + ((info.found && b.name)? b.name : BRANCH_CODE);
    if(b.tel || b.fax){ contact.textContent = `TEL: ${b.tel||'-'} / FAX: ${b.fax||'-'}`; }
  }catch{ badge.textContent = "店舗：取得失敗"; }
  finally{ hideLoading(); }
})();

/* ===== 車種（04_VehicleDifficulty） ===== */
async function initVehicleSelect(){
  const sel = qs('vehicleSelect');
  sel.disabled = true;
  sel.innerHTML = '<option value="">車種を読み込み中…</option>';
  try{
    showLoading("車種リストを取得中…");
    const res = await callFlow({ intent: "listVehicles" });
    const items = Array.isArray(res.items) ? res.items : [];
    if(items.length === 0){ sel.innerHTML = '<option value="">登録が見つかりません</option>'; sel.disabled = false; return; }
    const list = items
      .filter(x => (x.code||'').trim() !== '')
      .map(x => ({ code: (x.code||'').trim().toUpperCase(), label: (x.label||'').trim() }))
      .sort((a,b)=> a.label.localeCompare(b.label,'ja'));
    sel.innerHTML = '<option value="">車種を選択</option>';
    for(const it of list){ sel.insertAdjacentHTML('beforeend', `<option value="${it.code}">${it.label?`${it.label} (${it.code})`:it.code}</option>`); }
  }catch(e){
    sel.innerHTML = '<option value="">読み込みに失敗しました（手入力に切替可）</option>';
    qs('msg').textContent = '車種リストの取得に失敗：' + e.message;
  }finally{ sel.disabled = false; hideLoading(); }
}
initVehicleSelect();

/* ===== 手入力モード切替（見た目を維持） ===== */
qs('manualToggleBtn').addEventListener('click', (e)=>{
  const btn = e.currentTarget, pressed = btn.getAttribute('aria-pressed')==='true';
  const manual = qs('vehicleManual'); const sel = qs('vehicleSelect');
  if(pressed){ btn.setAttribute('aria-pressed','false'); btn.textContent='リストにない場合は手入力に切替'; manual.style.display='none'; manual.value=''; sel.disabled=false; }
  else{ btn.setAttribute('aria-pressed','true'); btn.textContent='手入力をやめてリストに戻す'; manual.style.display=''; sel.disabled=true; manual.focus(); }
  resetProductSelections();
  triggerAvailability();
});
function getVehicleCode(){ return (qs('manualToggleBtn').getAttribute('aria-pressed')==='true' ? (qs('vehicleManual').value||'') : (qs('vehicleSelect').value||'')).trim().toUpperCase(); }

/* ===== 可用性 ===== */
async function loadAvailability(){
  qs('msg').textContent = '';
  const vehicle = getVehicleCode();
  if(!BRANCH_CODE || !vehicle){ return; }
  try{
    showLoading("情報を取得中…");
    const payload = { dealer: DEALER_CODE, branch: BRANCH_CODE, vehicle, intent: "availability" };
    const data = await callFlow(payload);
    const av = data.availability || {};
    setSelect(qs('navTier'), (av.NAV?.allowedTiers||"SIMPLE,BASIC,PREMIUM").split(','), av.NAV?.allowed===false, av.NAV?.reason);
    setSelect(qs('etcTier'), (av.ETC?.allowedTiers||"SIMPLE,BASIC,PREMIUM").split(','), av.ETC?.allowed===false, av.ETC?.reason);
    setSelect(qs('drcTier'), (av.DRC?.allowedTiers||"SIMPLE,BASIC,PREMIUM").split(','), av.DRC?.allowed===false, av.DRC?.reason);
    setSelect(qs('bcmTier'), (av.BCM?.allowedTiers||"SIMPLE,BASIC,PREMIUM").split(','), av.BCM?.allowed===false, av.BCM?.reason);
    setSelect(qs('rseTier'), (av.RSE?.allowedTiers||"SIMPLE,BASIC,PREMIUM").split(','), av.RSE?.allowed===false, av.RSE?.reason);

await initOptionSelect('OPT_USB',      'optUSB',  'optUSBInfo');
await initOptionSelect('OPT_HDMI',     'optHDMI', 'optHDMIInfo');
await initOptionSelect('OPT_OTTOCAST', 'optOTTO', 'optOTTOInfo');

  }catch(e){
    qs('msg').textContent = '情報取得に失敗しました: ' + e.message;
  }finally{
    hideLoading();
  }
}
const triggerAvailability = debounce(loadAvailability, 350);
qs('vehicleSelect').addEventListener('change', ()=>{ resetProductSelections(); triggerAvailability(); });
qs('vehicleManual').addEventListener('input', ()=>{ resetProductSelections(); triggerAvailability(); });

/* ===== カタログ明細 ===== */
async function fetchCatalogItem(category, { grade=null, code=null }){
  const vehicle = getVehicleCode();
  const payload = { intent:"getCatalogItem", category, grade, code, vehicle };
  try{ return await callFlow(payload); } catch(e){ return {}; }
}
function renderItemInfo(elId, info){
  const el = qs(elId);
  if(!info || (!info.name && !info.detail)){ el.textContent = ""; return; }
  const name = info.name || "";
  const detail = info.detail || "";
  el.textContent = `商品名：${name}\n${detail ? `詳細：${detail}` : ''}`;
}

/* メインカテゴリ：選択 → 商品名/特徴 */
async function onMainSelect(category, selectId, infoId){
  const grade = (qs(selectId).value||'').trim();
  if(!grade){ renderItemInfo(infoId, null); selectedCatalogInfo[category]=null; return; }
  try{
    showLoading("商品情報を取得中…");
    const info = await fetchCatalogItem(category, { grade });
    renderItemInfo(infoId, info);
    selectedCatalogInfo[category] = { category, grade, ...info };
  } finally { hideLoading(); }
}

/* オプション一覧（OPT_*） */
async function initOptionSelect(category, selectId, infoId){
  const sel  = document.getElementById(selectId);
  const info = document.getElementById(infoId);
  if(!sel) return;

  // 初期化
  sel.disabled = true;
  sel.innerHTML = '<option value="">読み込み中…</option>';
  info && (info.textContent = '');

  try{
    // ★ vehicle / branch を渡す（Flow 側が条件で絞っても空にならない）
    const resp = await callFlow({
      intent: 'listOptions',
      category,
      vehicle: (typeof getVehicleCode === 'function' ? getVehicleCode() : undefined),
      branch: (typeof BRANCH_CODE !== 'undefined' ? BRANCH_CODE : undefined)
    });

    // ★ 構造が複雑な場合に対応するため、空配列を確実に取得
    const raw = Array.isArray(resp?.items) ? resp.items
              : Array.isArray(resp?.body)  ? resp.body
              : [];

    sel.innerHTML = '<option value="">選択なし</option>';

    // ★ 修正後のロジック: codeがない場合でも、nameやdetailを確実にvalueとして利用する
    for(const it of raw){
      // 1. まず Code/ID を探す（値として優先）
      const code = String(
        it.code ?? it.Code ?? it.id ?? it.ID ?? ''
      ).trim();
      
      // 2. 次に Name/Detail を探す（ラベルとして優先）
      const name = String(
        it.name ?? it.Name ?? it.detail ?? it.Detail ?? ''
      ).trim();

      // 3. 値 (value) を確定: Codeがあればそれを使用。なければNameを使用。
      const value = code || name;
      
      // 4. ラベル (text) を確定: Nameがあればそれを使用。なければCodeを使用。
      const label = name || code;

      // 値もラベルも空の場合はスキップ
      if (!value && !label) continue;
      
      // 最終的な value は必ず value を使用、表示テキストは label を使用
      sel.insertAdjacentHTML('beforeend', `<option value="${value}">${label}</option>`);
    }
  }catch(e){
    sel.innerHTML = '<option value="">読み込み失敗</option>';
  }finally{
    sel.disabled = false; // ★ 失敗時でも再操作できるようにする
  }
}

/* オプション選択時：code → 商品名/詳細 (修正版) */
async function onOptionSelect(category, selectId, infoId){
  const sel = qs(selectId);
  const code = (sel.value||'').trim();
  if(!code){ renderItemInfo(infoId, null); selectedCatalogInfo[category]=null; return; }
  
  // 選択されたオプションの表示名を取得
  const name_for_flow = sel.options[sel.selectedIndex]?.text || code;

  try{
    showLoading("商品情報を取得中…");
    
    // callFlowを直接呼び出し、codeとnameを両方渡す
    const d = await callFlow({
      intent:'getCatalogItem',
      category,
      code: code,
      name: name_for_flow, 
      vehicle: (typeof getVehicleCode === 'function' ? getVehicleCode() : undefined),
      branch: (typeof BRANCH_CODE !== 'undefined' ? BRANCH_CODE : undefined)
    });
    
    // 商品情報の表示ロジック
    const info = qs(infoId);
    const name = d?.name || d?.field_3 || d?.Name || '';
    const detail = d?.detail || d?.field_4 || d?.Detail || '';
    info.textContent = [name?`商品名：${name}`:'', detail?`詳細：${detail}`:''].filter(Boolean).join('\n');
    
    selectedCatalogInfo[category] = { category, code, ...d };

  } finally { hideLoading(); }
}

/* 選択されたカタログ情報（見積POSTに同梱） */
const selectedCatalogInfo = {
  NAV:null, ETC:null, DRC:null, BCM:null, RSE:null,
  OPT_USB:null, OPT_HDMI:null, OPT_OTTOCAST:null
};

/* イベント紐付け */
qs('navTier').addEventListener('change', ()=> onMainSelect('NAV','navTier','navInfo'));
qs('etcTier').addEventListener('change', ()=> onMainSelect('ETC','etcTier','etcInfo'));
qs('drcTier').addEventListener('change', ()=> onMainSelect('DRC','drcTier','drcInfo'));
qs('bcmTier').addEventListener('change', ()=> onMainSelect('BCM','bcmTier','bcmInfo'));
qs('rseTier').addEventListener('change', ()=> onMainSelect('RSE','rseTier','rseInfo'));

// ★ オプションのイベント紐付け（onOptionSelectに処理を統合）
qs('optUSB').addEventListener('change', ()=> onOptionSelect('OPT_USB','optUSB','optUSBInfo'));
qs('optHDMI').addEventListener('change', ()=> onOptionSelect('OPT_HDMI','optHDMI','optHDMIInfo'));
qs('optOTTO').addEventListener('change', ()=> onOptionSelect('OPT_OTTOCAST','optOTTO','optOTTOInfo'));

/* ===== CSVエクスポート & 印刷 ===== */
function exportLinesToCSV(lines, summary, filename = "見積明細.csv"){
  if (!Array.isArray(lines) || lines.length === 0) {
    alert("エクスポート対象の明細がありません。");
    return;
  }
  const preferredOrder = ["name","qty","unit","amount","price","part","labor","coef","code","grade","detail"];
  const presentKeys = new Set();
  for (const row of lines) { Object.keys(row||{}).forEach(k => presentKeys.add(k)); }
  const headers = preferredOrder.filter(k => presentKeys.has(k));
  const jpHeader = {
    name:"品目", qty:"数量", unit:"単価", amount:"金額", price:"計",
    part:"部材", labor:"工賃", coef:"係数", code:"コード", grade:"グレード", detail:"詳細"
  };
  const headerRow = headers.map(h => jpHeader[h] || h);
  const escapeCSV = (v) => {
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  };
  const rows = [headerRow.join(",")];
  for (const r of lines) { rows.push(headers.map(h => escapeCSV(r[h])).join(",")); }
  if (summary) {
    rows.push("");
    if (summary.subtotal!=null) rows.push(["小計", "", "", summary.subtotal].join(","));
    if (summary.tax!=null) rows.push(["消費税", "", "", summary.tax].join(","));
    if (summary.totalRounded!=null) rows.push(["合計", "", "", summary.totalRounded].join(","));
  }
  const csv = rows.join("\n");
  const blob = new Blob([new Uint8Array([0xEF,0xBB,0xBF]), csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}
function printQuote(){ window.print(); }

/* ===== 見積（POST → 結果表示＋内訳） ===== */
qs('btnQuote').onclick = async ()=>{
  const btn = qs('btnQuote');
  qs('msg').textContent = '';
  btn.disabled = true; showLoading("見積を計算中…");
  try{
    if(!BRANCH_CODE) throw new Error("店舗情報がQRに含まれていません。正しいQRからアクセスしてください。");
    const vehicle = getVehicleCode(); if(!vehicle) throw new Error("車種を選択するか、手入力してください。");

    const selTo10 = v => v && v.length ? "1" : "0";
    const payload = {
      intent: "quote",
      salesperson: qs('salesperson').value.trim(),
      vehicle,
      nav_selected: selTo10(qs('navTier').value),
      etc_selected: selTo10(qs('etcTier').value),
      drc_selected: selTo10(qs('drcTier').value),
      bcm_selected: selTo10(qs('bcmTier').value),
      rse_selected: selTo10(qs('rseTier').value),
      nav_grade: qs('navTier').value || null,
      etc_grade: qs('etcTier').value || null,
      drc_grade: qs('drcTier').value || null,
      bcm_grade: qs('bcmTier').value || null,
      rse_grade: qs('rseTier').value || null,
      opt_usb_code: (qs('optUSB').value||null),
      opt_hdmi_code: (qs('optHDMI').value||null),
      opt_otto_code: (qs('optOTTO').value||null),
      selectedItems: Object.values(selectedCatalogInfo).filter(Boolean)
    };

    const data = await callFlow(payload);

    if(data.validation?.errors?.length){
      qs('result').style.display='none';
      qs('msg').textContent = data.validation.errors.join(' / ');
      return;
    }

    // シンプル行
    const linesEl = qs('lines'); linesEl.innerHTML = '';
    (data.display?.lines||[]).forEach(l=>{
      const name = l.name || '';
      const detail = l.detail ? `<div class="small" style="color:#374151">${l.detail}</div>` : '';
      linesEl.insertAdjacentHTML('beforeend',
        `<div class="line"><div>${name}${detail}</div><div>¥${Number(l.price||l.amount||0).toLocaleString()}</div></div>`
      );
    });

    qs('grand').textContent = '合計(税込) ¥' + Number(data.totals?.grand||0).toLocaleString();
    qs('notes').textContent = (data.display?.notes||[]).join(' / ') || '';
    qs('result').style.display = 'block';
    await sleep(50);
    document.getElementById('result').scrollIntoView({behavior:'smooth',block:'start'});
    
    // CSVエクスポート用に最終見積もりデータを保存
    window.lastQuote = data;

    /* --- 詳細内訳（可変列ヘッダ） --- */
    const bd = qs('breakdown');
    const btnT = qs('toggleDetail');
    const fmtN = n => (n==null || isNaN(n)) ? '-' : Number(n).toLocaleString();
    const has = (o,k) => o && Object.prototype.hasOwnProperty.call(o,k) && o[k]!=null;

    const lines = data.display?.lines || [];
    const colPart  = lines.some(l=>has(l,'part'));
    const colLabor = lines.some(l=>has(l,'labor'));
    const colCoef  = lines.some(l=>has(l,'coef'));
    const colCode  = lines.some(l=>has(l,'code'));
    const colGrade = lines.some(l=>has(l,'grade'));

    const headers = ["項目"];
    if(colPart)  headers.push("部品");
    if(colLabor) headers.push("工賃");
    if(colCoef)  headers.push("係数");
    headers.push("計");

    const headHtml = `<tr>${headers.map(h=>`<th${h!=="項目"?" style=\"text-align:right\"":""}>${h}</th>`).join('')}</tr>`;

    const rows = lines.map(l=>{
      const name = l.name || '';
      const detail = l.detail || '';
      const code = l.code || '';
      const grade = l.grade || '';
      const price= `¥${fmtN(l.price!=null?l.price:l.amount)}`;
      const cells = [];
      const left = `${name}${colCode&&code?`<div class=\"small\">コード: ${code}</div>`:''}${colGrade&&grade?`<div class=\"small\">グレード: ${grade}</div>`:''}${detail?`<div class=\"small\" style=\"white-space:pre-wrap\">${detail}</div>`:''}`;
      cells.push(`<td>${left}</td>`);
      if(colPart)  cells.push(`<td style=\"text-align:right\">${has(l,'part')?`¥${fmtN(l.part)}`:'-'}</td>`);
      if(colLabor) cells.push(`<td style=\"text-align:right\">${has(l,'labor')?`¥${fmtN(l.labor)}`:'-'}</td>`);
      if(colCoef)  cells.push(`<td style=\"text-align:right\">${has(l,'coef')?String(l.coef):'-'}</td>`);
      cells.push(`<td style=\"text-align:right\"><b>${price}</b></td>`);
      return `<tr>${cells.join('')}</tr>`;
    }).join('');

    const t = data.totals || {};
    const summaryRows = [
      (t.subtotal!=null)        ? `<tr><th>小計（税抜）</th><td style=\"text-align:right\">¥${fmtN(t.subtotal)}</td></tr>` : '',
      (t.roundUnit!=null)       ? `<tr><th>丸め単位</th><td style=\"text-align:right\">${t.roundUnit}</td></tr>` : '',
      (t.subtotalRounded!=null) ? `<tr><th>小計（丸め後・税抜）</th><td style=\"text-align:right\">¥${fmtN(t.subtotalRounded)}</td></tr>` : '',
      (t.taxRate!=null)         ? `<tr><th>消費税率</th><td style=\"text-align:right\">${t.taxRate}%</td></tr>` : '',
      (t.taxInt!=null)          ? `<tr><th>消費税額</th><td style=\"text-align:right\">¥${fmtN(t.taxInt)}</td></tr>` : '',
      (t.grand!=null)           ? `<tr><th>合計（税込）</th><td style=\"text-align:right\"><b>¥${fmtN(t.grand)}</b></td></tr>` : ''
    ].filter(Boolean).join('');

    bd.innerHTML = `
      <div style="font-weight:700;margin:6px 0 4px">明細</div>
      <table class="tbl">
        <thead>${headHtml}</thead>
        <tbody>${rows || `<tr><td colspan="${headers.length}" class="small">明細情報が取得できませんでした</td></tr>`}</tbody>
      </table>

      <div style="font-weight:700;margin:12px 0 4px">サマリ</div>
      <table class="tbl"><tbody>${summaryRows}</tbody></table>
    `;

    btnT.style.display = 'inline-block';
    bd.style.display = 'none';
    btnT.textContent = '詳細を表示';
    btnT.onclick = ()=>{
      const isOpen = bd.style.display !== 'none';
      bd.style.display = isOpen ? 'none' : 'block';
      btnT.textContent = isOpen ? '詳細を表示' : '詳細を閉じる';
    };
  }catch(e){
    qs('msg').textContent = e.message || '処理に失敗しました';
  }finally{
    hideLoading(); btn.disabled = false;
  }
};

/* ===== QR branch 表示 ===== */
(function initBranchFromQR(){
  const badge = qs('branchBadge');
  if(!BRANCH_CODE){ badge.textContent = '店舗：未指定（店舗コードなし）'; }
})();

/* ===== エクスポートボタン ===== */
(function bindExportButtons(){
  const btnCsv = document.getElementById('btnCsv');
  const btnPdf = document.getElementById('btnPdf');
  if (btnCsv) btnCsv.addEventListener('click', ()=>{
    const q = window.lastQuote;
    if (!q?.display?.lines) return alert('見積結果がありません。');
    const summary = q.display?.summary || { subtotal:q.totals?.subtotalRounded, tax:q.totals?.taxInt, totalRounded:q.totals?.grand };
    exportLinesToCSV(q.display.lines, summary, '見積明細.csv');
  });
  if (btnPdf) btnPdf.addEventListener('click', ()=> printQuote());
})();
</script>
</body>
</html>