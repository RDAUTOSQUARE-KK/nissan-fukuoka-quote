<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>見積アシスタント</title>
<style>
:root{--gap:12px}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5}
.container{max-width:900px;margin:0 auto;padding:16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media (max-width:768px){.row{grid-template-columns:1fr}}
.card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
h1{font-size:20px;margin:0 0 8px}
h2{font-size:16px;margin:0 0 10px}
label{font-weight:700;font-size:13px;display:block;margin:4px 0}
select, input[type="text"], input[type="number"]{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
.checkbox{display:flex;align-items:center;gap:8px}
.section{margin-top:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
.stack{display:flex;gap:8px;align-items:center}
hr{border:none;border-top:1px solid #f3f4f6;margin:12px 0}
.loading{display:none;position:fixed;inset:0;background:rgba(255,255,255,.6);backdrop-filter:saturate(180%) blur(2px);z-index:999}
.spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:42px;height:42px;border:4px solid #e5e7eb;border-top-color:#111827;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{font-size:13px;text-align:right;border-bottom:1px dashed #e5e7eb;padding:6px 8px;white-space:nowrap}
.table th:first-child,.table td:first-child{text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#111827;color:#fff;font-size:11px}
select:disabled, input:disabled{background:#f9fafb;color:#9ca3af}
input[type="checkbox"]{width:1.1em;height:1.1em;vertical-align:middle;border:1px solid #9ca3af;border-radius:4px;background:
linear-gradient(#fff,#fff) padding-box,linear-gradient(90deg,#fff 50%,transparent 0) border-box,
radial-gradient(circle at 50% 50%,#111827 50%,transparent 52%) 0 0/0 0 no-repeat}
input[type="checkbox"]:checked{background:
linear-gradient(#fff,#fff) padding-box,linear-gradient(90deg,#fff 50%,transparent 0) border-box,
radial-gradient(circle at 50% 50%,#111827 50%,transparent 52%) 50% 50%/calc(100% - 13px) calc(1em - 2px), calc(100% - 2.5rem) 50%;
background-size:5px 5px,5px 5px,1px 1.8em;background-repeat:no-repeat}
button{cursor:pointer;background:#111827;color:#fff;border:1px solid #111827;font-weight:700}
button:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#fff;color:#111827;border:1px solid #d1d5db}
.small{font-size:12px;color:var(--muted)}
.err{color:#b00020;margin-top:6px}
.kv{font-size:13px;color:#374151}
.kv b{display:inline-block;min-width:3.5rem}
.line{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #e5e7eb}
.line:last-child{border-bottom:none}
.total{font-size:20px;font-weight:800;margin-top:8px}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media (max-width:480px){.row-2{grid-template-columns:1fr}}
.note{font-size:12px;color:#374151;margin-top:8px}
.iteminfo{font-size:12px;color:#374151;margin-top:6px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div></div>
<div class="container">
  <h1>見積アシスタント <span class="badge">beta</span></h1>

  <div class="row">
    <div class="card">
      <h2>店舗情報</h2>
      <div class="kv"><b>店舗</b><span id="branchName">-</span></div>
      <div class="kv"><b>住所</b><span id="branchAddr">-</span></div>
      <div class="kv"><b>TEL</b><span id="branchTel">-</span></div>
      <div class="section">
        <label>車種</label>
        <select id="vehicleSelect"></select>
      </div>
      <!-- 手入力 UI は廃止 -->
      <!-- <div class="stack" style="margin-top:6px">
        <button class="btn-ghost small" id="manualToggleBtn">リストにない場合は手入力に切替</button>
        <input id="vehicleManual" type="text" placeholder="車種コードを入力（例：ABC-123）" style="display:none">
      </div> -->
    </div>

    <div class="card">
      <h2>レバレート等</h2>
      <div class="grid-2">
        <div><label>レバレート（円/時間）</label><input type="number" id="laborUnit" value="10000" min="0" step="100"></div>
        <div><label>車種別係数</label><input type="number" id="vehicleCoef" value="1" min="0" step="0.1"></div>
      </div>
      <div class="grid-2 section">
        <div>
          <label>ナビ</label>
          <select id="navTier"></select>
        </div>
        <div>
          <label>ETC</label>
          <select id="etcTier"></select>
        </div>
      </div>
      <div class="grid-2 section">
        <div>
          <label>ドラレコ（DRC）</label>
          <select id="drcTier"></select>
        </div>
        <div>
          <label>BCM（バックカメラ）</label>
          <select id="bcmTier"></select>
        </div>
      </div>
      <div class="grid-2 section">
        <div>
          <label>RSE（後席モニター）</label>
          <select id="rseTier"></select>
        </div>
      </div>
    </div>
  </div>

  <div class="row section">
    <div class="card">
      <h2>オプション</h2>

      <div class="section">
        <div class="checkbox">
          <input type="checkbox" id="optUSB">
          <label for="optUSB">延長保証</label>
        </div>
        <div class="stack">
          <select id="optUSBSelect"></select>
          <button class="btn-ghost small" id="optUSBInfoBtn">詳細</button>
        </div>
        <div class="iteminfo" id="optUSBInfo"></div>
      </div>

      <div class="section">
        <div class="checkbox">
          <input type="checkbox" id="optHDMI">
          <label for="optHDMI">HDMI入力コード</label>
        </div>
        <div class="stack">
          <select id="optHDMISelect"></select>
          <button class="btn-ghost small" id="optHDMIInfoBtn">詳細</button>
        </div>
        <div class="iteminfo" id="optHDMIInfo"></div>
      </div>

      <div class="section">
        <div class="checkbox">
          <input type="checkbox" id="optOTTO">
          <label for="optOTTO">OTTOCAST</label>
        </div>
        <div class="stack">
          <select id="optOTTOSelect"></select>
          <button class="btn-ghost small" id="optOTTOInfoBtn">詳細</button>
        </div>
        <div class="iteminfo" id="optOTTOInfo"></div>
      </div>
    </div>

    <div class="card">
      <h2>見積</h2>
      <div id="lines"></div>
      <div class="total" id="total">合計: - 円</div>
      <div class="note">内訳の表示／非表示はボタンで切替できます。</div>
      <div class="section">
        <button id="quoteBtn">見積を作成</button>
        <button id="toggleBreakdownBtn" class="btn-ghost">詳細を表示</button>
      </div>
      <div id="breakdown" style="display:none">
        <table class="table" id="breakdownTable">
          <thead>
            <tr id="breakdownHeader">
              <!-- 可変列（part/labor/coef/code/grade）がある場合のみ出す -->
            </tr>
          </thead>
          <tbody id="breakdownBody"></tbody>
        </table>
      </div>
      <div id="msg" class="err"></div>
    </div>
  </div>
</div>

<script>
/* ====== 接続設定 ====== */
const FLOW_URL = "https://default65d7f344287e476a8e27e2ad17aaf5.f3.environment.api.powerplatform.com:443/powerautomate/...sig=qFlU...";
const BRANCH_CODE = new URLSearchParams(location.search).get('branch');

/* ユーティリティ */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const showLoading = ()=> qs('#loading').style.display = 'block';
const hideLoading = ()=> qs('#loading').style.display = 'none';
const fmt = n => new Intl.NumberFormat('ja-JP').format(Math.round(Number(n)||0));

/* ====== セレクト描画（カテゴリ別ラベル、BCMはPREMIUM非表示） ====== */
function setSelect(el, tiers, disabled, reason){
  if (!el) return; // 要素未描画でも落ちない
  const id = (el && el.id) || "";

  const labelMaps = {
    navTier: { SIMPLE:"ディスプレイオーディオ7インチ", BASIC:"ベーシック7インチ", PREMIUM:"プレミアム9インチ" },
    etcTier: { SIMPLE:"ETC1.0", BASIC:"ETC2.0", PREMIUM:"ETC2.0ナビ連動" },
    drcTier: { SIMPLE:"フロントのみ1カメラ", BASIC:"前後2カメラ", PREMIUM:"ナビ連動前後2カメラ" },
    bcmTier: { SIMPLE:"【アラウンドビューモニター用】ナビに映像出力", BASIC:"スタンダードバックカメラ", PREMIUM:null }, // PREMIUM非表示
    rseTier: { SIMPLE:"10.1型フリップダウンモニター", BASIC:"9型ヘッドレスト裏モニター2セット（助手席・運転席）", PREMIUM:"13.3型フリップダウンモニター" }
  };
  const defaultLabels = { SIMPLE:"シンプル", BASIC:"ベーシック", PREMIUM:"プレミアム" };
  const labels = labelMaps[id] || defaultLabels;

  el.innerHTML = `<option value="">${disabled ? `選択不可（${reason||''}）` : '選択なし'}</option>`;

  let list = Array.isArray(tiers) ? tiers.slice() : String(tiers||'').split(',');
  if (id === 'bcmTier') list = list.filter(t => String(t).toUpperCase().trim() !== 'PREMIUM');

  if (!disabled) {
    list.forEach(t => {
      const key = String(t).toUpperCase().trim();
      const label = labels[key] ?? defaultLabels[key] ?? key;
      if (label) el.insertAdjacentHTML('beforeend', `<option value="${key}">${label}</option>`);
    });
  }
  el.disabled = !!disabled;
}

/* ====== データ取得 ====== */
async function callFlow(payload){
  const res = await fetch(FLOW_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('サーバでエラーが発生しました');
  return await res.json();
}

/* ====== 起動時：店舗情報表示 ====== */
async function loadBranchInfo(){
  const data = await callFlow({ intent:'branchInfo', branch: BRANCH_CODE });
  qs('#branchName').textContent = data?.name ?? '-';
  qs('#branchAddr').textContent = data?.address ?? '-';
  qs('#branchTel').textContent  = data?.tel ?? '-';
}

/* ====== 車種の読み込み ====== */
async function loadVehicles(){
  const data = await callFlow({ intent:'listVehicles', branch: BRANCH_CODE });
  const sel = qs('#vehicleSelect');
  sel.innerHTML = '<option value="">車種を選択</option>';
  (data?.items||[]).forEach(it => {
    sel.insertAdjacentHTML('beforeend', `<option value="${(it.code||'').toUpperCase()}">${it.name||it.code}</option>`);
  });
}

/* ====== 現在の車種コード（手入力UIは廃止→セレクトのみ） ====== */
function getVehicleCode(){
  return (qs('select#vehicleSelect')?.value || '').trim().toUpperCase();
}

/* ====== ティア＆オプションの可用性 ====== */
async function loadAvailability(){
  const vehicle = getVehicleCode();
  if(!vehicle){ ['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=> setSelect(qs('#'+id), [], true, '車種未選択')); return; }

  const data = await callFlow({ intent:'availability', vehicle, branch: BRANCH_CODE });
  setSelect(qs('#navTier'), data?.NAV?.tiers, data?.NAV?.disabled, data?.NAV?.reason);
  setSelect(qs('#etcTier'), data?.ETC?.tiers, data?.ETC?.disabled, data?.ETC?.reason);
  setSelect(qs('#drcTier'), data?.DRC?.tiers, data?.DRC?.disabled, data?.DRC?.reason);
  setSelect(qs('#bcmTier'), data?.BCM?.tiers, data?.BCM?.disabled, data?.BCM?.reason);
  setSelect(qs('#rseTier'), data?.RSE?.tiers, data?.RSE?.disabled, data?.RSE?.reason);

  await initOptionSelect('OPT_USB',  '#optUSB',  '#optUSBSelect',  '#optUSBInfo',  '#optUSBInfoBtn');
  await initOptionSelect('OPT_HDMI', '#optHDMI', '#optHDMISelect', '#optHDMIInfo', '#optHDMIInfoBtn');
  await initOptionSelect('OPT_OTTOCAST', '#optOTTO', '#optOTTOSelect', '#optOTTOInfo', '#optOTTOInfoBtn');
}

/* ====== オプション：チェック → 商品名/詳細 ====== */
async function initOptionSelect(category, chkSel, selSel, infoSel, btnSel){
  const chk = qs(chkSel), sel = qs(selSel), info = qs(infoSel), btn = qs(btnSel);
  const vehicle = getVehicleCode();
  sel.innerHTML = '<option value="">選択なし</option>';
  info.textContent = '';
  btn.onclick = async ()=>{
    const code = sel.value;
    if(!code) return;
    const d = await callFlow({ intent:'getCatalogItem', category, code });
    info.textContent = `${d?.name||''}\n${d?.detail||''}`;
  };

  // チェック時のみ一覧取得
  chk.onchange = async ()=>{
    info.textContent = '';
    sel.innerHTML = '<option value="">選択なし</option>';
    if(!chk.checked) return;
    const resp = await callFlow({ intent:'listOptions', category, vehicle, branch: BRANCH_CODE });
    (resp?.items||[]).forEach(it=>{
      sel.insertAdjacentHTML('beforeend', `<option value="${(it.code||'').toUpperCase()}">${it.name||it.code}</option>`);
    });
  };
}

/* ====== 画面初期化 ====== */
function resetProductSelections(){
  ['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=> setSelect(qs('#'+id), [], true, '車種未選択'));
  ['optUSBSelect','optHDMISelect','optOTTOSelect'].forEach(id=>{ const el=qs('#'+id); if(el) el.innerHTML='<option value=\"\">選択なし</option>'; });
  ['optUSB','optHDMI','optOTTO'].forEach(id=>{ const el=qs('#'+id); if(el) el.checked=false; });
  ['optUSBInfo','optHDMIInfo','optOTTOInfo'].forEach(id=>{ const el=qs('#'+id); if(el) el.textContent=''; });
}

/* ====== 見積実行 ====== */
qs('#quoteBtn').onclick = async ()=>{
  try{
    qs('msg').textContent='';
    showLoading(); qs('#quoteBtn').disabled = true;

    const vehicle = getVehicleCode();
    const payload = {
      intent:'quote',
      branch: BRANCH_CODE,
      vehicle,
      labor_unit: Number(qs('#laborUnit').value||0),
      coef: Number(qs('#vehicleCoef').value||1),
      nav_grade: qs('#navTier').value,
      etc_grade: qs('#etcTier').value,
      drc_grade: qs('#drcTier').value,
      bcm_grade: qs('#bcmTier').value,
      rse_grade: qs('#rseTier').value,
      opt_usb: qs('#optUSB').checked ? qs('#optUSBSelect').value : '',
      opt_hdmi: qs('#optHDMI').checked ? qs('#optHDMISelect').value : '',
      opt_otto: qs('#optOTTO').checked ? qs('#optOTTOSelect').value : ''
    };

    const res = await callFlow(payload);

    /* ライン表示 */
    const linesDiv = qs('#lines');
    const rows = res?.display?.lines || [];
    linesDiv.innerHTML = '';
    rows.forEach(row=>{
      const left = [row.name, row.detail].filter(Boolean).join(' ／ ');
      const right = fmt(row.amount ?? row.price ?? row.unit ?? 0) + ' 円';
      const el = document.createElement('div');
      el.className='line';
      el.innerHTML = `<div>${left}</div><div>${right}</div>`;
      linesDiv.appendChild(el);
    });
    qs('#total').textContent = '合計: ' + fmt(res?.display?.total ?? 0) + ' 円';

    /* 内訳テーブル（可変列） */
    const header = qs('#breakdownHeader');
    const body = qs('#breakdownBody');
    header.innerHTML=''; body.innerHTML='';
    const has = {
      part: rows.some(r=> typeof r.part === 'number'),
      labor: rows.some(r=> typeof r.labor === 'number'),
      coef: rows.some(r=> r.coef !== undefined && r.coef !== null ),
      code: rows.some(r=> r.code),
      grade: rows.some(r=> r.grade)
    };
    const cols = [{key:'name',label:'品目'}];
    if(has.part) cols.push({key:'part',label:'部品'});
    if(has.labor) cols.push({key:'labor',label:'工賃'});
    if(has.coef) cols.push({key:'coef',label:'係数'});
    if(has.code) cols.push({key:'code',label:'コード'});
    if(has.grade) cols.push({key:'grade',label:'グレード'});
    cols.push({key:'amount',label:'金額'});

    header.innerHTML = cols.map(c=>`<th>${c.label}</th>`).join('');
    rows.forEach(r=>{
      const tds = cols.map(c=>{
        let v = r[c.key];
        if(c.key==='amount') v = r.amount ?? r.price ?? r.unit ?? 0;
        if(['part','labor','amount'].includes(c.key)) v = fmt(v||0);
        return `<td>${(v??'')}</td>`;
      }).join('');
      body.insertAdjacentHTML('beforeend', `<tr>${tds}</tr>`);
    });

    /* 詳細トグル */
    qs('#toggleBreakdownBtn').onclick = ()=>{
      const bd = qs('#breakdown');
      const btnT = qs('#toggleBreakdownBtn');
      const isOpen = bd.style.display !== 'none';
      bd.style.display = isOpen ? 'none' : 'block';
      btnT.textContent = isOpen ? '詳細を表示' : '詳細を閉じる';
    };
    /* --- ここまで内訳 --- */

  }catch(e){
    qs('msg').textContent = e.message || '処理に失敗しました';
  }finally{
    hideLoading(); qs('#quoteBtn').disabled = false;
  }
};

/* ====== 起動時処理 ====== */
(async ()=>{
  try{
    showLoading();
    await loadBranchInfo();
    await loadVehicles();
    resetProductSelections();

    // 車種変更で毎回オプション再読込
    qs('#vehicleSelect').addEventListener('change', ()=>{
      resetProductSelections();
      loadAvailability();
    });

    // 廃止した手入力欄が存在しても落ちないように（互換ガード）
    const _vm = qs('vehicleManual');
    if(_vm){ _vm.addEventListener('input', ()=>{ resetProductSelections(); loadAvailability(); }); }

    await loadAvailability();
  }catch(e){
    qs('msg').textContent = e.message || '初期化に失敗しました';
  }finally{
    hideLoading();
  }
})();
</script>
</body>
</html>