<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>見積アシスタント</title>
<style>
:root{--gap:12px}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5}
.container{max-width:980px;margin:0 auto;padding:12px}
.header{display:flex;gap:8px;align-items:center;padding:8px 0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#111827;color:#fff;font-size:11px}
.card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media (max-width:840px){.row{grid-template-columns:1fr}}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
label{font-weight:700;font-size:13px;display:block;margin:4px 0}
input[type="text"], input[type="number"], select{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
.stack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.checkbox{display:flex;align-items:center;gap:8px}
.small{font-size:12px}
hr{border:none;border-top:1px solid #f3f4f6;margin:12px 0}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{font-size:13px;text-align:right;border-bottom:1px dashed #e5e7eb;padding:6px 8px;white-space:nowrap}
.table th:first-child,.table td:first-child{text-align:left}
.line{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #e5e7eb}
.line:last-child{border-bottom:none}
.total{font-size:20px;font-weight:800;margin-top:8px}
button{cursor:pointer;background:#111827;color:#fff;border:1px solid #111827;font-weight:700;padding:8px 12px;border-radius:10px}
button.btn-ghost{background:#fff;color:#111827;border:1px solid #d1d5db}
button:disabled{opacity:.5;cursor:not-allowed}
.loading{display:none;position:fixed;inset:0;background:rgba(255,255,255,.6);backdrop-filter:saturate(180%) blur(2px);z-index:999}
.spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:42px;height:42px;border:4px solid #e5e7eb;border-top-color:#111827;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
.loading-msg { margin-top: 10px; color:#374151; font-size:14px; text-align:center }
</style>
</head>
<body>
  <div class="header">
    <span class="badge">ディーラー：日産福岡</span>
    <span class="badge" id="branchBadge">店舗：読込中...</span>
  </div>
  <div class="kv" id="branchContact" style="margin:4px 0 12px 0;"></div>

  <div class="card">
    <div class="stack">
      <div>
        <label>ご担当者様</label>
        <input id="salesperson" placeholder="入力してください">
      </div>
      <div>
        <label>お客様名</label>
        <input id="customer" placeholder="入力してください">
      </div>
    </div>
    <div class="stack" style="margin-top:8px">
      <div style="min-width:240px;flex:1">
        <label>車種</label>
        <select id="vehicleSelect"></select>
      </div>
      <div class="small">または</div>
      <div style="min-width:240px;flex:1">
        <label>車種コード（手入力）</label>
        <input id="vehicleManual" placeholder="例：ABC-123">
      </div>
    </div>
    <div class="small" style="margin-top:6px">QRの <code>?branch=XXXX</code> パラメータで店舗は自動選択されます。</div>
  </div>

  <div class="row">
    <div class="card">
      <h3>レバレート・係数</h3>
      <div class="grid-2">
        <div>
          <label>レバレート（円/時間）</label>
          <input id="laborUnit" type="number" value="10000" min="0" step="100">
        </div>
        <div>
          <label>車種別係数</label>
          <input id="vehicleCoef" type="number" value="1" min="0" step="0.1">
        </div>
      </div>

      <hr>
      <h3>ティア選択</h3>
      <div class="grid-3">
        <div>
          <label>NAV</label>
          <select id="navTier"></select>
        </div>
        <div>
          <label>ETC</label>
          <select id="etcTier"></select>
        </div>
        <div>
          <label>DRC</label>
          <select id="drcTier"></select>
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>BCM（バックカメラ）</label>
          <select id="bcmTier"></select>
        </div>
        <div>
          <label>RSE（後席モニター）</label>
          <select id="rseTier"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>オプション</h3>

      <div class="section">
        <div class="checkbox">
          <input type="checkbox" id="optUSB">
          <label for="optUSB">延長保証</label>
        </div>
        <div class="stack">
          <select id="optUSBSelect"></select>
          <button class="btn-ghost small" id="optUSBInfoBtn">詳細</button>
        </div>
        <div class="small" id="optUSBInfo"></div>
      </div>

      <div class="section" style="margin-top:10px">
        <div class="checkbox">
          <input type="checkbox" id="optHDMI">
          <label for="optHDMI">HDMI入力コード</label>
        </div>
        <div class="stack">
          <select id="optHDMISelect"></select>
          <button class="btn-ghost small" id="optHDMIInfoBtn">詳細</button>
        </div>
        <div class="small" id="optHDMIInfo"></div>
      </div>

      <div class="section" style="margin-top:10px">
        <div class="checkbox">
          <input type="checkbox" id="optOTTO">
          <label for="optOTTO">OTTOCAST</label>
        </div>
        <div class="stack">
          <select id="optOTTOSelect"></select>
          <button class="btn-ghost small" id="optOTTOInfoBtn">詳細</button>
        </div>
        <div class="small" id="optOTTOInfo"></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h3>見積</h3>
      <div id="lines"></div>
      <div class="total" id="total">合計: - 円</div>

      <div class="stack" style="margin-top:8px">
        <button id="quoteBtn">見積を作成</button>
        <button id="toggleBreakdownBtn" class="btn-ghost">詳細を表示</button>
        <div id="msg" class="small" style="color:#b00020;margin-left:auto"></div>
      </div>

      <div id="breakdown" style="display:none;margin-top:8px">
        <table class="table" id="breakdownTable">
          <thead><tr id="breakdownHeader"></tr></thead>
          <tbody id="breakdownBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>店舗メモ</h3>
      <textarea id="memo" rows="10" style="width:100%;border:1px solid #d1d5db;border-radius:10px;padding:8px" placeholder="店舗メモ（任意）"></textarea>
    </div>
  </div>

  <div class="loading" id="loading"><div class="spinner"></div><div class="loading-msg">通信中…</div></div>
</div>

<script>
/* ===== 接続情報 ===== */
const FLOW_URL = "https://default65d7f344287e476a8e27e2ad17aaf5.f3.environment.api.powerplatform.com:443/powerautomate/...sig=qFlU...";
const BRANCH_CODE = new URLSearchParams(location.search).get('branch');

/* ===== ユーティリティ ===== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const showLoading = ()=> qs('#loading').style.display = 'block';
const hideLoading = ()=> qs('#loading').style.display = 'none';
const fmt = n => new Intl.NumberFormat('ja-JP').format(Math.round(Number(n)||0));

/* ===== ティアのセレクト描画（見た目そのまま、カテゴリ別ラベルに変更、BCMはPREMIUM非表示） ===== */
function setSelect(el, tiers, disabled, reason){
  if (!el) return; // null セーフ

  const id = (el && el.id) || "";

  // カテゴリ別ラベル
  const labelMaps = {
    navTier: { SIMPLE:"ディスプレイオーディオ7インチ", BASIC:"ベーシック7インチ", PREMIUM:"プレミアム9インチ" },
    etcTier: { SIMPLE:"ETC1.0", BASIC:"ETC2.0", PREMIUM:"ETC2.0ナビ連動" },
    drcTier: { SIMPLE:"フロントのみ1カメラ", BASIC:"前後2カメラ", PREMIUM:"ナビ連動前後2カメラ" },
    bcmTier: { SIMPLE:"【アラウンドビューモニター用】ナビに映像出力", BASIC:"スタンダードバックカメラ", PREMIUM:null }, // PREMIUMは非表示
    rseTier: { SIMPLE:"10.1型フリップダウンモニター", BASIC:"9型ヘッドレスト裏モニター2セット（助手席・運転席）", PREMIUM:"13.3型フリップダウンモニター" }
  };
  const defaultLabels = { SIMPLE:"シンプル", BASIC:"ベーシック", PREMIUM:"プレミアム" };
  const labels = labelMaps[id] || defaultLabels;

  // 先頭行
  el.innerHTML = `<option value="">${disabled ? `選択不可（${reason||''}）` : '選択なし'}</option>`;

  // BCM は PREMIUM を除外
  let list = Array.isArray(tiers) ? tiers.slice() : String(tiers||'').split(',');
  if (id === 'bcmTier') list = list.filter(t => String(t).toUpperCase().trim() !== 'PREMIUM');

  if (!disabled) {
    list.forEach(t => {
      const key = String(t).toUpperCase().trim();
      const label = labels[key] ?? defaultLabels[key] ?? key;
      if (label) el.insertAdjacentHTML('beforeend', `<option value="${key}">${label}</option>`);
    });
  }
  el.disabled = !!disabled;
}

/* ===== Flow 呼び出し ===== */
async function callFlow(payload){
  const res = await fetch(FLOW_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('サーバでエラーが発生しました');
  return await res.json();
}

/* ===== 店舗情報 ===== */
async function loadBranchInfo(){
  const data = await callFlow({ intent:'branchInfo', branch: BRANCH_CODE });
  qs('#branchBadge').textContent = '店舗：' + (data?.name || '-');
  qs('#branchContact').textContent = [data?.address, data?.tel].filter(Boolean).join(' / ');
}

/* ===== 車種一覧 ===== */
async function loadVehicles(){
  const data = await callFlow({ intent:'listVehicles', branch: BRANCH_CODE });
  const sel = qs('#vehicleSelect');
  sel.innerHTML = '<option value="">選択してください</option>';
  (data?.items||[]).forEach(it=>{
    sel.insertAdjacentHTML('beforeend', `<option value="${(it.code||'').toUpperCase()}">${it.name||it.code}</option>`);
  });
}

/* ===== 現在の車種コード（見た目は以前のまま：手入力があれば優先） ===== */
function getVehicleCode(){
  const m = (qs('#vehicleManual')?.value || '').trim();
  if(m) return m.toUpperCase();
  return (qs('#vehicleSelect')?.value || '').trim().toUpperCase();
}

/* ===== 可用性（ティア & オプション） ===== */
async function loadAvailability(){
  const vehicle = getVehicleCode();
  if(!vehicle){
    ['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=> setSelect(qs('#'+id), [], true, '車種未選択'));
    return;
  }
  const data = await callFlow({ intent:'availability', vehicle, branch: BRANCH_CODE });
  setSelect(qs('#navTier'), data?.NAV?.tiers, data?.NAV?.disabled, data?.NAV?.reason);
  setSelect(qs('#etcTier'), data?.ETC?.tiers, data?.ETC?.disabled, data?.ETC?.reason);
  setSelect(qs('#drcTier'), data?.DRC?.tiers, data?.DRC?.disabled, data?.DRC?.reason);
  setSelect(qs('#bcmTier'), data?.BCM?.tiers, data?.BCM?.disabled, data?.BCM?.reason);
  setSelect(qs('#rseTier'), data?.RSE?.tiers, data?.RSE?.disabled, data?.RSE?.reason);

  // オプションはチェック時に listOptions を取得
  await initOptionSelect('OPT_USB',  '#optUSB',  '#optUSBSelect',  '#optUSBInfo',  '#optUSBInfoBtn');
  await initOptionSelect('OPT_HDMI', '#optHDMI', '#optHDMISelect', '#optHDMIInfo', '#optHDMIInfoBtn');
  await initOptionSelect('OPT_OTTOCAST', '#optOTTO', '#optOTTOSelect', '#optOTTOInfo', '#optOTTOInfoBtn');
}

/* ===== オプション：チェック → 商品名/詳細 ===== */
async function initOptionSelect(category, chkSel, selSel, infoSel, btnSel){
  const chk = qs(chkSel), sel = qs(selSel), info = qs(infoSel), btn = qs(btnSel);
  sel.innerHTML = '<option value="">選択なし</option>';
  info.textContent = '';
  btn.onclick = async ()=>{
    const code = sel.value;
    if(!code) return;
    const d = await callFlow({ intent:'getCatalogItem', category, code });
    info.textContent = `${d?.name||''}\n${d?.detail||''}`;
  };
  chk.onchange = async ()=>{
    info.textContent = '';
    sel.innerHTML = '<option value="">選択なし</option>';
    if(!chk.checked) return;
    const resp = await callFlow({ intent:'listOptions', category, vehicle: getVehicleCode(), branch: BRANCH_CODE });
    (resp?.items||[]).forEach(it=>{
      sel.insertAdjacentHTML('beforeend', `<option value="${(it.code||'').toUpperCase()}">${it.name||it.code}</option>`);
    });
  };
}

/* ===== 初期化 ===== */
function resetProductSelections(){
  ['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=> setSelect(qs('#'+id), [], true, '車種未選択'));
  ['optUSBSelect','optHDMISelect','optOTTOSelect'].forEach(id=>{ const el=qs('#'+id); if(el) el.innerHTML='<option value=\"\">選択なし</option>'; });
  ['optUSB','optHDMI','optOTTO'].forEach(id=>{ const el=qs('#'+id); if(el) el.checked=false; });
  ['optUSBInfo','optHDMIInfo','optOTTOInfo'].forEach(id=>{ const el=qs('#'+id); if(el) el.textContent=''; });
}

/* ===== 見積実行 ===== */
qs('#quoteBtn').onclick = async (ev)=>{
  const btn = ev.currentTarget;
  try{
    qs('msg') && (qs('msg').textContent='');
    showLoading(); btn.disabled = true;

    const payload = {
      intent:'quote',
      branch: BRANCH_CODE,
      vehicle: getVehicleCode(),
      labor_unit: Number(qs('#laborUnit').value||0),
      coef: Number(qs('#vehicleCoef').value||1),
      nav_grade: qs('#navTier').value,
      etc_grade: qs('#etcTier').value,
      drc_grade: qs('#drcTier').value,
      bcm_grade: qs('#bcmTier').value,
      rse_grade: qs('#rseTier').value,
      opt_usb: qs('#optUSB').checked ? qs('#optUSBSelect').value : '',
      opt_hdmi: qs('#optHDMI').checked ? qs('#optHDMISelect').value : '',
      opt_otto: qs('#optOTTO').checked ? qs('#optOTTOSelect').value : ''
    };

    const res = await callFlow(payload);

    /* ライン表示 */
    const linesDiv = qs('#lines');
    const rows = res?.display?.lines || [];
    linesDiv.innerHTML = '';
    rows.forEach(row=>{
      const left = [row.name, row.detail].filter(Boolean).join(' ／ ');
      const right = fmt(row.amount ?? row.price ?? row.unit ?? 0) + ' 円';
      const el = document.createElement('div');
      el.className='line';
      el.innerHTML = `<div>${left}</div><div>${right}</div>`;
      linesDiv.appendChild(el);
    });
    qs('#total').textContent = '合計: ' + fmt(res?.display?.total ?? 0) + ' 円';

    /* 内訳（列は可変） */
    const header = qs('#breakdownHeader');
    const body = qs('#breakdownBody');
    header.innerHTML=''; body.innerHTML='';
    const has = {
      part: rows.some(r=> typeof r.part === 'number'),
      labor: rows.some(r=> typeof r.labor === 'number'),
      coef: rows.some(r=> r.coef !== undefined && r.coef !== null),
      code: rows.some(r=> r.code),
      grade: rows.some(r=> r.grade)
    };
    const cols = [{key:'name',label:'品目'}];
    if(has.part) cols.push({key:'part',label:'部品'});
    if(has.labor) cols.push({key:'labor',label:'工賃'});
    if(has.coef) cols.push({key:'coef',label:'係数'});
    if(has.code) cols.push({key:'code',label:'コード'});
    if(has.grade) cols.push({key:'grade',label:'グレード'});
    cols.push({key:'amount',label:'金額'});

    header.innerHTML = cols.map(c=>`<th>${c.label}</th>`).join('');
    rows.forEach(r=>{
      const tds = cols.map(c=>{
        let v = r[c.key];
        if(c.key==='amount') v = r.amount ?? r.price ?? r.unit ?? 0;
        if(['part','labor','amount'].includes(c.key)) v = fmt(v||0);
        return `<td>${(v??'')}</td>`;
      }).join('');
      body.insertAdjacentHTML('beforeend', `<tr>${tds}</tr>`);
    });

    /* 詳細トグル */
    qs('#toggleBreakdownBtn').onclick = ()=>{
      const bd = qs('#breakdown');
      const btnT = qs('#toggleBreakdownBtn');
      const isOpen = bd.style.display !== 'none';
      bd.style.display = isOpen ? 'none' : 'block';
      btnT.textContent = isOpen ? '詳細を表示' : '詳細を閉じる';
    };

  }catch(e){
    qs('msg') && (qs('msg').textContent = e.message || '処理に失敗しました');
  }finally{
    hideLoading(); btn.disabled = false;
  }
};

/* ===== 起動時処理 ===== */
(async ()=>{
  try{
    showLoading();
    await loadBranchInfo();
    await loadVehicles();
    resetProductSelections();

    // 変更時に再計算
    qs('#vehicleSelect').addEventListener('change', ()=>{ resetProductSelections(); loadAvailability(); });
    const _vm = qs('vehicleManual'); // 手入力欄が無い環境でも落ちない
    if(_vm){ _vm.addEventListener('input', ()=>{ resetProductSelections(); loadAvailability(); }); }

    await loadAvailability();
  }catch(e){
    qs('msg') && (qs('msg').textContent = e.message || '初期化に失敗しました');
  }finally{
    hideLoading();
  }
})();
</script>
</body>
</html>