<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>簡易見積ツール</title>
<style>
:root{--pad:14px;--gap:12px;--radius:14px;--fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#ffffff}
html,body{background:#fafafa;color:var(--fg)}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:640px;margin:0 auto;padding:env(safe-area-inset-top) var(--pad) env(safe-area-inset-bottom)}
.header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:16px 0 8px}
.badge{padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;font-size:12px;white-space:nowrap}
.card{border:1px solid var(--bd);border-radius:var(--radius);padding:var(--pad);margin:12px 0;background:var(--bg);box-shadow:0 1px 0 rgba(0,0,0,.02)}
.stack{display:flex;flex-direction:column;gap:var(--gap)}
label{font-weight:600;font-size:14px;display:block;margin-bottom:6px}
input,select,button{padding:12px;border:1px solid #d1d5db;border-radius:10px;width:100%;font-size:16px;background:#fff}
select{appearance:none;background-image:
 linear-gradient(45deg, transparent 50%, #9ca3af 50%),
 linear-gradient(135deg, #9ca3af 50%, transparent 50%),
 linear-gradient(to right, #d1d5db, #d1d5db);
background-position:calc(100% - 18px) calc(1em - 2px), calc(100% - 13px) calc(1em - 2px), calc(100% - 2.5rem) 50%;
background-size:5px 5px,5px 5px,1px 1.8em;background-repeat:no-repeat}
button{cursor:pointer;background:#111827;color:#fff;border:1px solid #111827;font-weight:700}
button:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:#fff;color:#111827;border:1px solid #d1d5db}
.small{font-size:12px;color:var(--muted)}
.err{color:#b00020;margin-top:6px}
.kv{font-size:13px;color:#374151}
.kv b{display:inline-block;min-width:3.5rem}
.line{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #e5e7eb}
.line:last-child{border-bottom:none}
.total{font-size:20px;font-weight:800;margin-top:8px}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
@media (max-width:480px){.row-2{grid-template-columns:1fr}}
.note{font-size:12px;color:#374151;margin-top:8px}
.iteminfo{font-size:12px;color:#374151;margin-top:6px;white-space:pre-wrap}

/* breakdown table */
.tbl { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px }
.tbl th, .tbl td { border:1px solid #e5e7eb; padding:6px 8px; vertical-align:top }
.tbl th { background:#f9fafb; text-align:left; white-space:nowrap }
.toggle { margin-top:10px }

/* Loading */
.loading { position: fixed; inset: 0; display: none; place-items: center; background: rgba(255,255,255,.75); backdrop-filter: blur(1px); z-index: 9999; }
.loading.show { display: grid; }
.spinner { width: 48px; height: 48px; border-radius: 50%; border: 4px solid #e5e7eb; border-top-color: #111827; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-msg { margin-top: 10px; color:#374151; font-size:14px; text-align:center }
</style>
</head>
<body>
  <div class="header">
    <span class="badge">ディーラー：日産福岡</span>
    <span class="badge" id="branchBadge">店舗：読込中...</span>
  </div>
  <div class="kv" id="branchContact" style="margin:4px 0 12px 0;"></div>

  <div class="card">
    <div class="stack">
      <div>
        <label>ご担当者様</label>
        <input id="salesperson" placeholder="入力してください">
      </div>

      <div>
        <label>車種コード（model_code）</label>
        <select id="vehicleSelect"></select>
        <div class="small" id="vehicleHelp">選択/入力すると自動で適合情報を読み込みます。</div>
        <div class="stack" style="margin-top:6px">
          <button class="btn-ghost" id="manualToggleBtn" aria-pressed="false">リストにない場合は手入力に切替</button>
          <input id="vehicleManual" placeholder="例: E13 / C28 / FE0" style="display:none">
        </div>
      </div>

      <!-- メインカテゴリ -->
      <div class="row-2">
        <div>
          <label>ナビゲーション</label>
          <select id="navTier"><option value="">選択なし</option></select>
          <div id="navInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>ETC</label>
          <select id="etcTier"><option value="">選択なし</option></select>
          <div id="etcInfo" class="iteminfo"></div>
        </div>
      </div>

      <div class="row-2">
        <div>
          <label>ドライブレコーダー</label>
          <select id="drcTier"><option value="">選択なし</option></select>
          <div id="drcInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>バックカメラ（BCM）</label>
          <select id="bcmTier"><option value="">選択なし</option></select>
          <div id="bcmInfo" class="iteminfo"></div>
        </div>
      </div>

      <div>
        <label>後席モニター</label>
        <select id="rseTier"><option value="">選択なし</option></select>
        <div id="rseInfo" class="iteminfo"></div>
      </div>

      <!-- オプション（プルダウン） -->
      <div class="row-2">
        <div>
          <label>延長保証</label>
          <select id="optUSB"><option value="">選択なし</option></select>
          <div id="optUSBInfo" class="iteminfo"></div>
        </div>
        <div>
          <label>HDMI入力コード</label>
          <select id="optHDMI"><option value="">選択なし</option></select>
          <div id="optHDMIInfo" class="iteminfo"></div>
        </div>
      </div>
      <div>
        <label>OTTOCAST</label>
        <select id="optOTTO"><option value="">選択なし</option></select>
        <div id="optOTTOInfo" class="iteminfo"></div>
      </div>

      <div class="stack">
        <button id="btnQuote">見積を表示</button>
        <div id="msg" class="err"></div>
        <div class="small">※ 店舗はQRのbranchパラメータから自動取得します。</div>
      </div>
    </div>
  </div>

  <!-- 結果 -->
  <div class="card" id="result" style="display:none">
    <div id="lines"></div>
    <div class="total" id="grand"></div>
    <button id="toggleDetail" class="btn-ghost toggle" style="display:none">詳細を表示</button>
    <div id="breakdown" style="display:none"></div>
    <div id="notes" class="note"></div>
  </div>

  <!-- Loading overlay -->
  <div id="loading" class="loading" aria-live="polite" aria-busy="true">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div class="spinner" role="progressbar" aria-label="読込中"></div>
      <div class="loading-msg" id="loadingMsg">読込中です…</div>
    </div>
  </div>

<script>
/* ===== 接続設定（既存を踏襲） ===== */
const FLOW_URL = "https://default65d7f344287e476a8e27e2ad17aaf5.f3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cc92c47cc1374afcb742cad801a2de4d/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=qFlUmKJ42rtDOVD9jRbRy1NkE3AQTQmQMgX15viXKuA";
const DEALER_CODE = "NISSAN_FUKUOKA";
const BRANCH_CODE = new URLSearchParams(location.search).get('branch')?.trim() || "";

/* ===== 汎用 ===== */
const qs = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
let debounceTimer=null;
function debounce(fn, ms=400){ return (...a)=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>fn(...a), ms); }; }
function showLoading(msg){ const l=qs('loading'); const m=qs('loadingMsg'); if(msg) m.textContent=msg; l.classList.add('show'); }
function hideLoading(){ qs('loading').classList.remove('show'); }
const fmt = n => new Intl.NumberFormat('ja-JP').format(Math.round(Number(n)||0));

/* ===== Flow 呼び分け ===== */
async function callFlow(body){
  const base = { dealer: DEALER_CODE, branch: BRANCH_CODE || '' };
  const res = await fetch(FLOW_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json", "Accept":"application/json" },
    body: JSON.stringify({ ...base, ...body })
  });
  if(!res.ok){
    const t = await res.text().catch(()=>String(res.status));
    throw new Error(`Flow HTTP ${res.status}: ${t}`);
  }
  return res.json();
}

/* ===== 店舗情報 ===== */
(async ()=>{
  const badge = qs('branchBadge'); const contact = qs('branchContact');
  if(!BRANCH_CODE){ badge.textContent = "店舗：未指定（QRのbranchが必要）"; return; }
  try{
    showLoading("店舗情報を取得中…");
    const info = await callFlow({ intent:"branchInfo" });
    const b = info.branch || {};
    badge.textContent = "店舗：" + ((info.found && b.name)? b.name : BRANCH_CODE);
    const telFax = [b.tel,b.fax].filter(Boolean);
    if(telFax.length){ contact.textContent = `TEL: ${b.tel||'-'} / FAX: ${b.fax||'-'}`; }
  }catch{ badge.textContent = "店舗：取得失敗"; }
  finally{ hideLoading(); }
})();

/* ===== 車種 ===== */
async function initVehicleSelect(){
  const sel = qs('vehicleSelect');
  sel.disabled = true;
  sel.innerHTML = '<option value="">車種を読み込み中…</option>';
  try{
    showLoading("車種リストを取得中…");
    const res = await callFlow({ intent: "listVehicles" });
    const items = Array.isArray(res.items) ? res.items : [];
    sel.innerHTML = items.length ? '<option value="">車種を選択</option>' : '<option value="">登録が見つかりません</option>';
    items
      .filter(x => (x.code||'').trim() !== '')
      .map(x => ({ code: (x.code||'').trim().toUpperCase(), label: (x.label||'').trim() }))
      .sort((a,b)=> a.label.localeCompare(b.label,'ja'))
      .forEach(it => sel.insertAdjacentHTML('beforeend', `<option value="${it.code}">${it.label?`${it.label} (${it.code})`:it.code}</option>`));
  }catch(e){
    sel.innerHTML = '<option value="">読み込みに失敗しました（手入力に切替可）</option>';
    qs('msg').textContent = '車種リストの取得に失敗：' + e.message;
  }finally{ sel.disabled = false; hideLoading(); }
}
initVehicleSelect();

/* ===== 手入力切替（UIは既存のまま） ===== */
qs('manualToggleBtn').addEventListener('click', (e)=>{
  const btn = e.currentTarget, pressed = btn.getAttribute('aria-pressed')==='true';
  const manual = qs('vehicleManual'); const sel = qs('vehicleSelect');
  if(pressed){ btn.setAttribute('aria-pressed','false'); btn.textContent='リストにない場合は手入力に切替'; manual.style.display='none'; manual.value=''; sel.disabled=false; }
  else{ btn.setAttribute('aria-pressed','true'); btn.textContent='手入力をやめてリストに戻す'; manual.style.display=''; sel.disabled=true; manual.focus(); }
  resetProductSelections();
  triggerAvailability();
});
function getVehicleCode(){ return (qs('manualToggleBtn').getAttribute('aria-pressed')==='true' ? (qs('vehicleManual').value||'') : (qs('vehicleSelect').value||'')).trim().toUpperCase(); }

/* ===== ティアのセレクト描画（カテゴリ別ラベル／BCMはPREMIUM非表示＋空対策） ===== */
function setSelect(el, tiers, disabled, reason){
  if(!el) return;
  const id = el.id || "";
  const defaultLabels = { SIMPLE:"シンプル", BASIC:"ベーシック", PREMIUM:"プレミアム" };
  const labelMaps = {
    navTier: { SIMPLE:"ディスプレイオーディオ7インチ", BASIC:"ベーシック7インチ", PREMIUM:"プレミアム9インチ" },
    etcTier: { SIMPLE:"ETC1.0", BASIC:"ETC2.0", PREMIUM:"ETC2.0ナビ連動" },
    drcTier: { SIMPLE:"フロントのみ1カメラ", BASIC:"前後2カメラ", PREMIUM:"ナビ連動前後2カメラ" },
    bcmTier: { SIMPLE:"【アラウンドビューモニター用】ナビに映像出力", BASIC:"スタンダードバックカメラ", PREMIUM:null },
    rseTier: { SIMPLE:"10.1型フリップダウンモニター", BASIC:"9型ヘッドレスト裏モニター2セット（助手席・運転席）", PREMIUM:"13.3型フリップダウンモニター" }
  };
  const labels = labelMaps[id] || defaultLabels;

  el.innerHTML = `<option value="">${disabled?`選択不可（${reason||''}）`:'選択なし'}</option>`;
  let list = Array.isArray(tiers) ? tiers.slice() : String(tiers||'').split(',').map(s=>s.trim()).filter(Boolean);

  // BCMはPREMIUMを表示しない
  if(id === 'bcmTier'){ list = list.filter(t => String(t).toUpperCase() !== 'PREMIUM'); }
  // 空になったら明示表示
  if(id === 'bcmTier' && !disabled && list.length === 0){
    el.innerHTML = `<option value="">選択不可（該当なし）</option>`;
    el.disabled = true;
    return;
  }

  if(!disabled){
    list.forEach(t=>{
      const key = String(t).toUpperCase();
      const label = (labels[key] ?? defaultLabels[key] ?? key);
      if(label){ el.insertAdjacentHTML('beforeend', `<option value="${key}">${label}</option>`); }
    });
  }
  el.disabled = !!disabled;
}

/* ===== 可用性（ティア＋OPT） ===== */
async function loadAvailability(){
  qs('msg').textContent = '';
  const vehicle = getVehicleCode();
  if(!BRANCH_CODE || !vehicle){
    ['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=> setSelect(qs(id), [], true, '車種未選択'));
    return;
  }
  try{
    showLoading("可用性を取得中…");
    const resp = await callFlow({ intent: "availability", vehicle });
    const av = resp.availability || {};

    setSelect(qs('navTier'), String(av.NAV?.allowedTiers||'').split(',').filter(Boolean), av.NAV?.allowed===false, av.NAV?.reason);
    setSelect(qs('etcTier'), String(av.ETC?.allowedTiers||'').split(',').filter(Boolean), av.ETC?.allowed===false, av.ETC?.reason);
    setSelect(qs('drcTier'), String(av.DRC?.allowedTiers||'').split(',').filter(Boolean), av.DRC?.allowed===false, av.DRC?.reason);
    setSelect(qs('rseTier'), String(av.RSE?.allowedTiers||'').split(',').filter(Boolean), av.RSE?.allowed===false, av.RSE?.reason);

    // ★ BCM は BCM のみ参照
    const back = (av.BCM || {});
    const backTiers = String(back.allowedTiers||'').split(',').filter(Boolean);
    setSelect(qs('bcmTier'), backTiers, back.allowed===false, back.reason);

    // ★ OPT 3種：availability に項目があれば従い、無ければ listOptions で取得
    await initOptionFromAvailabilityOrList('OPT_USB',      'optUSB',  'optUSBInfo',      av.OPT_USB);
    await initOptionFromAvailabilityOrList('OPT_HDMI',     'optHDMI', 'optHDMIInfo',     av.OPT_HDMI);
    await initOptionFromAvailabilityOrList('OPT_OTTOCAST', 'optOTTO', 'optOTTOInfo',     av.OPT_OTTOCAST);

  }catch(e){
    qs('msg').textContent = '可用性の取得に失敗しました: ' + e.message;
  }finally{
    hideLoading();
  }
}
const triggerAvailability = debounce(loadAvailability, 350);
qs('vehicleSelect').addEventListener('change', ()=>{ resetProductSelections(); triggerAvailability(); });
qs('vehicleManual').addEventListener('input', ()=>{ resetProductSelections(); triggerAvailability(); });

/* ===== OPT 初期化（availability優先→listOptionsフォールバック） ===== */
async function initOptionFromAvailabilityOrList(category, selectId, infoId, avail){
  const sel  = document.getElementById(selectId);
  const info = document.getElementById(infoId);
  if(!sel) return;

  // 初期化
  sel.innerHTML = '<option value="">選択なし</option>';
  info && (info.textContent = '');
  sel.disabled = false;

  // availability が来ていて利用不可ならその場で終了
  if (avail && avail.allowed === false) {
    sel.innerHTML = `<option value="">選択不可（${avail.reason || '該当なし'}）</option>`;
    sel.disabled = true;
    return;
  }

  // availability に codes があればそのまま利用
  if (avail && Array.isArray(avail.codes) && avail.codes.length > 0) {
    for (const c of avail.codes) {
      const code = (typeof c === 'string' ? c : (c.code || '')).trim();
      const name = (typeof c === 'object' ? (c.name || c.label) : '') || code;
      if (code || name) sel.insertAdjacentHTML('beforeend', `<option value="${code||name}">${name||code}</option>`);
    }
    return;
  }

  // 無ければ listOptions
  await initOptionSelect(category, selectId, infoId);
}

/* ===== listOptions を確実に拾う・揺れに強い版 ===== */
async function initOptionSelect(category, selectId, infoId){
  const sel  = document.getElementById(selectId);
  const info = document.getElementById(infoId);
  if(!sel) return;

  sel.disabled = true;
  sel.innerHTML = '<option value="">読み込み中…</option>';
  info && (info.textContent = '');

  try{
    const resp = await callFlow({
      intent: 'listOptions',
      category,
      vehicle: getVehicleCode(),
      branch: BRANCH_CODE
    });

    // res.items / res.body のどちらでも拾う
    const raw = Array.isArray(resp?.items) ? resp.items
              : Array.isArray(resp?.body)  ? resp.body
              : [];

    sel.innerHTML = '<option value="">選択なし</option>';

    // code:null でも name/detail を値にフォールバックして確実に表示
    for(const it of raw){
      const code = String(it.code ?? it.Code ?? it.id ?? it.ID ?? it.name ?? it.detail ?? '').trim();
      const label = String(it.name ?? it.Name ?? it.detail ?? it.Detail ?? code).trim();
      if (!code && !label) continue;
      const value = code || label;
      sel.insertAdjacentHTML('beforeend', `<option value="${value}">${label}</option>`);
    }
  }catch(e){
    sel.innerHTML = '<option value="">読み込み失敗</option>';
  }finally{
    sel.disabled = false;
  }

  // 選択で詳細表示（code が無い環境でも動作）
  sel.onchange = async ()=>{
    if (!info) return;
    info.textContent = '';
    const value = (sel.value||'').trim();
    if(!value) return;

    const d = await callFlow({
      intent:'getCatalogItem',
      category,
      code: value,
      name: sel.options[sel.selectedIndex]?.text || value,
      vehicle: getVehicleCode(),
      branch: BRANCH_CODE
    });

    const name = d?.name || d?.field_3 || d?.Name || '';
    const detail = d?.detail || d?.field_4 || d?.Detail || '';
    info.textContent = [name?`商品名：${name}`:'', detail?`詳細：${detail}`:''].filter(Boolean).join('\n');
  };
}

/* ===== カタログ取得（BCMに統一） ===== */
async function fetchCatalogItem(category, { grade=null, code=null }){
  const vehicle = getVehicleCode();
  try{
    const r = await callFlow({ intent:"getCatalogItem", category, grade, code, vehicle });
    return r || {};
  }catch(e){
    return {};
  }
}
function renderItemInfo(elId, info){
  const el = qs(elId);
  if(!el) return;
  if(!info || (!info.name && !info.detail && !info.field_3 && !info.field_4)){ el.textContent = ""; return; }
  const name = info.name || info.field_3 || "";
  const detail = info.detail || info.field_4 || "";
  el.textContent = `商品名：${name}${detail?`\n詳細：${detail}`:''}`;
}

/* メインカテゴリ：選択 → 情報表示 */
async function onMainSelect(category, selectId, infoId){
  const grade = (qs(selectId).value||'').trim();
  if(!grade){ renderItemInfo(infoId, null); selectedCatalogInfo[category]=null; return; }
  try{
    showLoading("商品情報を取得中…");
    const info = await fetchCatalogItem(category, { grade });
    renderItemInfo(infoId, info);
    selectedCatalogInfo[category] = { category, grade, ...info };
  } finally { hideLoading(); }
}

/* 選択状態（見積へ同梱） */
const selectedCatalogInfo = {
  NAV:null, ETC:null, DRC:null, BCM:null, RSE:null,
  OPT_USB:null, OPT_HDMI:null, OPT_OTTOCAST:null
};

/* イベント（BCMに統一） */
qs('navTier').addEventListener('change', ()=> onMainSelect('NAV','navTier','navInfo'));
qs('etcTier').addEventListener('change', ()=> onMainSelect('ETC','etcTier','etcInfo'));
qs('drcTier').addEventListener('change', ()=> onMainSelect('DRC','drcTier','drcInfo'));
qs('bcmTier').addEventListener('change', ()=> onMainSelect('BCM','bcmTier','bcmInfo'));
qs('rseTier').addEventListener('change', ()=> onMainSelect('RSE','rseTier','rseInfo'));

/* ===== リセット（車種変更時） ===== */
function resetProductSelections(){
  ['navTier','etcTier','drcTier','bcmTier','rseTier'].forEach(id=>{
    const el = qs(id); if(!el) return;
    el.innerHTML = '<option value="">選択なし</option>'; el.value='';
    el.disabled = true; // メインカテゴリは従来どおり無効化
  });
  // ★ OPTは disable しない（中身だけクリア）
  ['optUSB','optHDMI','optOTTO'].forEach(id=>{
    const el = qs(id); if(!el) return;
    el.innerHTML = '<option value="">選択なし</option>'; el.value='';
  });
  ['navInfo','etcInfo','drcInfo','bcmInfo','rseInfo','optUSBInfo','optHDMIInfo','optOTTOInfo'].forEach(id=>{
    const el = qs(id); if(el) el.textContent = '';
  });
  Object.keys(selectedCatalogInfo).forEach(k => selectedCatalogInfo[k]=null);
}

/* ===== 見積実行 ===== */
qs('btnQuote').onclick = async ()=>{
  const btn = qs('btnQuote');
  try{
    qs('msg').textContent = '';
    btn.disabled = true; showLoading("見積を計算中…");

    if(!BRANCH_CODE) throw new Error("店舗情報（branch）がQRに含まれていません。正しいQRからアクセスしてください。");
    const vehicle = getVehicleCode(); if(!vehicle) throw new Error("車種を選択するか、手入力してください。");

    const payload = {
      intent:'quote',
      branch: BRANCH_CODE,
      vehicle,
      salesperson: (qs('salesperson').value||'').trim(),
      nav_grade: qs('navTier').value || null,
      etc_grade: qs('etcTier').value || null,
      drc_grade: qs('drcTier').value || null,
      bcm_grade: qs('bcmTier').value || null,
      rse_grade: qs('rseTier').value || null,
      opt_usb_code:  (qs('optUSB').value||''),
      opt_hdmi_code: (qs('optHDMI').value||''),
      opt_otto_code: (qs('optOTTO').value||''),
      selectedItems: Object.values(selectedCatalogInfo).filter(Boolean)
    };

    const data = await callFlow(payload);
    window.lastQuote = data; // ← エクスポート系で参照できるよう保持

    // ライン出力
    const linesEl = qs('lines'); linesEl.innerHTML = '';
    const rows = data?.display?.lines || [];
    rows.forEach(row=>{
      const left = [row.name, row.detail].filter(Boolean).join(' ／ ');
      const right = '¥' + fmt(row.amount ?? row.price ?? row.unit ?? 0);
      const el = document.createElement('div');
      el.className='line';
      el.innerHTML = `<div>${left}</div><div>${right}</div>`;
      linesEl.appendChild(el);
    });
    qs('grand').textContent = '合計(税込) ¥' + fmt(data?.totals?.grand ?? 0);
    qs('notes').textContent = (data.display?.notes||[]).join(' / ') || '';
    qs('result').style.display = 'block';

    // 詳細（可変列）
    const bd = qs('breakdown'); const btnT = qs('toggleDetail');
    const has = {
      part: rows.some(r=> typeof r.part === 'number'),
      labor: rows.some(r=> typeof r.labor === 'number'),
      coef: rows.some(r=> r.coef !== undefined && r.coef !== null )
    };
    const headers = ["項目"];
    if(has.part)  headers.push("部品");
    if(has.labor) headers.push("工賃");
    if(has.coef)  headers.push("係数");
    headers.push("計");
    const headHtml = `<tr>${headers.map(h=>`<th${h!=="項目"?" style=\"text-align:right\"":""}>${h}</th>`).join('')}</tr>`;
    const fmtN = n => (n==null || isNaN(n)) ? '-' : Number(n).toLocaleString();
    const bodyRows = rows.map(l=>{
      const price= `¥${fmtN(l.price!=null?l.price:l.amount)}`;
      const cells = [];
      const left = `${l.name||''}${l.code?`<div class="small">コード:${l.code}</div>`:''}${l.grade?`<div class="small">グレード:${l.grade}</div>`:''}${l.detail?`<div class="small" style="white-space:pre-wrap">${l.detail}</div>`:''}`;
      cells.push(`<td>${left}</td>`);
      if(has.part)  cells.push(`<td style="text-align:right">${l.part!=null?`¥${fmtN(l.part)}`:'-'}</td>`);
      if(has.labor) cells.push(`<td style="text-align:right">${l.labor!=null?`¥${fmtN(l.labor)}`:'-'}</td>`);
      if(has.coef)  cells.push(`<td style="text-align:right">${l.coef!=null?String(l.coef):'-'}</td>`);
      cells.push(`<td style="text-align:right"><b>${price}</b></td>`);
      return `<tr>${cells.join('')}</tr>`;
    }).join('');
    bd.innerHTML = `<div style="font-weight:700;margin:6px 0 4px">ライン明細</div><table class="tbl"><thead>${headHtml}</thead><tbody>${bodyRows}</tbody></table>`;
    btnT.style.display = 'inline-block';
    bd.style.display = 'none';
    btnT.textContent = '詳細を表示';
    btnT.onclick = ()=>{ const open = bd.style.display !== 'none'; bd.style.display = open ? 'none' : 'block'; btnT.textContent = open ? '詳細を表示' : '詳細を閉じる'; };

  }catch(e){
    qs('result').style.display = 'none';
    qs('msg').textContent = e.message || '処理に失敗しました';
  }finally{
    hideLoading(); qs('btnQuote').disabled = false;
  }
};

/* ===== 初期起動 ===== */
(function initBranchFromQR(){
  const badge = qs('branchBadge');
  if(!BRANCH_CODE){ badge.textContent = '店舗：未指定（QRのbranchが必要）'; }
})();
</script>
</body>
</html>